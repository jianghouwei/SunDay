function delUploadFile(master_key) {
	$.ajax({
		async	: false,
		type	: "POST",
		url		: "/AttachmentServlet39",
		data	: {
			"attachPK"		: master_key,
			"actionType"	: "deleteAttachment"
		},
		success	: function(r) {
			resizeTabHeight();// 调整高度
			var spaCnt = $('#' + swfid + 'file_count');
			if (spaCnt) {
				var cnt = parseInt(spaCnt.text());
				cnt--;
				if (cnt == 0) {
					spaCnt.text('');
				} else {
					spaCnt.text(cnt);
				}
			}
		},
		error	: function(err) {
			top.Dialog.warn(err);
		}
	});
}

function preLoad() {
	if (!this.support.loading) {
		top.Dialog.warn("\u9700\u8981\u5b89\u88c59.0.28\u4ee5\u4e0a\u7684flashPlayer");
		return false;
	}
}

function loadFailed() {
	top.Dialog.warn("\u52a0\u8f7d\u63d2\u4ef6\u5931\u8d25\uff0c\u8bf7\u5b89\u88c59.0.28\u4ee5\u4e0a\u7684flash!");
}

function fileQueued(file) {
	String.prototype.realLength = function() {
		return this.replace(/[^\x00-\xff]/ig, "**").length;
	};
	var swfid = this.customSettings.progressTarget;
	var swfu = SWFUpload.instances[this.movieName];
	file = swfu.getFile(file.index);//处理在最新版本flash下会乱码的问题
	var ulWidth = $("#" + swfid + "file_list").width();
	var liWidth = $("#" + swfid + "file_list").width() - 65;
	try {
		var fileName = file.name;
		var ext_name = file.type.substring(1) + "_div";
		var fileViewName = fileName.substring(0, fileName.lastIndexOf("."));
		var liObj = $("<li id='" + swfid + file.id + "'>" + "<a href='#' style='max-width: " + liWidth + "px;' class='fl " + ext_name + "' title='" + fileName + "(" + formatFileSize(file.size) + ")'>" + fileViewName + "</a>" + "<div class='progress'><span class='loading'></span></div><a class='delete_btn'></a></li>");
		$("#" + swfid + "file_list").append(liObj);
		if (liObj.width() > ulWidth) {
			liObj.children('a.fl').width(liWidth)
		}
		$("#" + swfid + file.id + " a.fl").click(function(event) {
			event.preventDefault();
			var li = $(this).parent();
			var fid = li.attr("id");
			downloadFile(li.attr("master_key"));
		});
		$("#" + swfid + file.id + " a.delete_btn").click(function(event) {
			event.preventDefault();
			deleteFile(this);
		});
	} catch (ex) {
		top.Dialog.warn(ex);
		this.debug(ex);
	}
}

function deleteFile(obj) {
	var li = $(obj).parent();
	var fid = li.attr("id");
	delUploadFile(li.attr("master_key"));
	li.remove();
	setFileCount();
}

function downloadFile(master_key) {
	if (typeof(master_key) == "object") {
		var li = $(master_key).parent();
		master_key = li.attr("master_key");
	}
	window.open("/AttachmentServlet39?attachPK=" + master_key + "&actionType=download&temp=" + new Date(), "newwindow", "height=10, width=10, top=0, left=0, toolbar=no, menubar=no, scrollbars=no, resizable=no,location=no, status=no");
}

function fileQueueError(file, errorCode, message) {
	var swfid = this.customSettings.progressTarget;
	var swfu = SWFUpload.instances[this.movieName];
	var msgDiv = $('div#' + swfid + 'message_div');
	var welcome = $('<div></div>');
	try {
		if (errorCode === SWFUpload.QUEUE_ERROR.QUEUE_LIMIT_EXCEEDED) {
			top.Dialog.warn("\u4e0a\u4f20\u7684\u6587\u4ef6\u8d85\u8fc7" + swfu.settings.file_upload_limit + "\u4e2a");
			return;
		}
		switch (errorCode) {
			case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT :
				top.Dialog.warn("\u6587\u4ef6[" + file.name + "]\u592a\u5927\uff0c\u76ee\u524d\u4e0a\u9650\u4e3a" + swfu.settings.file_size_limit + "");
				break;
			case SWFUpload.QUEUE_ERROR.ZERO_BYTE_FILE :
				top.Dialog.warn("\u4e0d\u80fd\u4e0a\u4f20\u7a7a\u767d\u6587\u4ef6[" + file.name + "]");
				break;
			case SWFUpload.QUEUE_ERROR.INVALID_FILETYPE :
				top.Dialog.warn("\u65e0\u6548\u7c7b\u578b[" + file.type + "]");
				break;
			default :
				if (file !== null) {
					top.Dialog.warn("\u672a\u77e5\u9519\u8bef[" + file.name + "]");
				}
				break;
		}
		msgDiv.find('p').append(welcome);
		msgDiv.attr("style", "margin-left:-8px;width:80%");
		msgDiv.find('p').attr("style", "height:100%;");
		msgDiv.show();
		setTimeout(function() {
			msgDiv.hide(300);
		}, 3000);
	} catch (ex) {
		this.debug(ex);
	}
}

function fileDialogComplete(numFilesSelected, numFilesQueued) {
	var swfid = this.customSettings.progressTarget;
	try {
		if (numFilesQueued > 0) {
			$("span#" + swfid + "welcome").text("");
			// $("#" + swfid + "outsideBox").show();
			this.startUpload();
		}
	} catch (ex) {
		this.debug(ex);
	}
}

function uploadStart(file) {
	var swfid = this.customSettings.progressTarget;
	try {
		var stats = $("#" + swfid + file.id).find("span#" + swfid + "info");
		stats.html("\u5df2\u4e0a\u4f20<s class='yscSize'>0</s>");
		var postobj = {
			"file.id"	: file.id,
			"fsize"		: file.size,
			"filename"	: file.name
		};
		this.setPostParams(postobj);
	} catch (ex) {
	}
	return true;
}

function uploadProgress(file, bytesLoaded, bytesTotal) {
	var swfid = this.customSettings.progressTarget;
	try {
		var percent = Math.ceil((bytesLoaded / bytesTotal) * 100);
		var fileList = $("#" + swfid + file.id);
		var progress = fileList.find(".progress");
		progress.find("span").css("width", percent + "%");
	} catch (ex) {
		this.debug(ex);
	}
}

function uploadSuccess(file, serverData) {
	var swfid = this.customSettings.progressTarget;
	var progress = $("#" + swfid + file.id).find(".progress");
	progress.hide();
	var arr = $.parseJSON(serverData);
	$("#" + swfid + "" + arr["file.id"]).attr("master_key", arr["master_key"]);
	resizeTabHeight();// 调整高度
	setFileCount();
}

/**
 * 设置文件个数
 */
function setFileCount() {
	var fileCount = $("#" + swfid + "file_list li").length;
	if (fileCount > 0) {
		$("#" + swfid + "file_count").html(fileCount);
	}
}

function uploadError(file, errorCode, message) {
	var swfid = this.customSettings.progressTarget;
	var msgDiv = $("div#" + swfid + "message_div");
	var welcome = $('<div></div>');
	try {
		var progress = $("#" + swfid + file.id).find(".progress");
		progress.hide("slow");
		switch (errorCode) {
			case SWFUpload.UPLOAD_ERROR.HTTP_ERROR :
				top.Dialog.warn("\u4e0a\u4f20\u9519\u8bef: " + message);
				break;
			case SWFUpload.UPLOAD_ERROR.UPLOAD_FAILED :
				top.Dialog.warn("\u4e0a\u4f20\u5931\u8d25");
				break;
			case SWFUpload.UPLOAD_ERROR.IO_ERROR :
				top.Dialog.warn("\u670d\u52a1\u5668\u9519\u8bef");
				break;
			case SWFUpload.UPLOAD_ERROR.SECURITY_ERROR :
				progress.setStatus("\u5b89\u5168\u6027\u9519\u8bef");
				break;
			case SWFUpload.UPLOAD_ERROR.UPLOAD_LIMIT_EXCEEDED :
				progress.setStatus("\u4e0a\u4f20\u8d85\u8fc7\u9650\u5236");
				break;
			case SWFUpload.UPLOAD_ERROR.FILE_VALIDATION_FAILED :
				progress.setStatus("\u9a8c\u8bc1\u5931\u8d25");
				break;
			case SWFUpload.UPLOAD_ERROR.FILE_CANCELLED :
				top.Dialog.warn("\u4e0a\u4f20\u53d6\u6d88");
				break;
			case SWFUpload.UPLOAD_ERROR.UPLOAD_STOPPED :
				top.Dialog.warn("\u4e0a\u4f20\u505c\u6b62");
				break;
			default :
				top.Dialog.warn("\u672a\u77e5\u9519\u8bef: " + errorCode);
				break;
		}
		msgDiv.find("p").append(welcome);
		msgDiv.show();
		setTimeout(function() {
			msgDiv.hide(300);
		}, 3000);
	} catch (ex) {
		this.debug(ex);
	}
}

function imageQueueError(file, errorCode, message) {
	var swfid = this.customSettings.progressTarget;
	var swfu = SWFUpload.instances[this.movieName];
	var welcome = $('<div></div>');
	try {
		switch (errorCode) {
			case SWFUpload.QUEUE_ERROR.FILE_EXCEEDS_SIZE_LIMIT :
				top.Dialog.warn("图片太大，目前上限为" + swfu.settings.file_size_limit);
				break;
			case SWFUpload.QUEUE_ERROR.ZERO_BYTE_FILE :
				top.Dialog.warn("不能上传空白文件");
				break;
			case SWFUpload.QUEUE_ERROR.INVALID_FILETYPE :
				top.Dialog.warn("无效类型");
				break;
			default :
				if (file !== null) {
					top.Dialog.warn("未知错误");
				}
				break;
		}
		$("span#" + swfid + "welcome").append(welcome);
	} catch (ex) {
		this.debug(ex);
	}
}

function uploadComplete(file) {
	this.startUpload();
}

function queueComplete(numFilesUploaded) {
}

function fileDialogStart() {
	var swfid = this.customSettings.progressTarget;
	var msgDiv = $("div#" + swfid + "message_div");
	var welcome = msgDiv.find("p");
	if (welcome[0]) {
		welcome.html('');
	}
}
